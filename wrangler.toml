# Shared configuration
name = "cloudstash"
main = "./src/cf-worker/index.ts"
compatibility_date = "2025-01-15"
compatibility_flags = ["nodejs_compat"]

[assets]
directory = "./dist"
not_found_handling = "single-page-application"
run_worker_first = ["/sync*", "/api/*", "/agents/*"]

[ai]
binding = "AI"

# ============================================================
# DEFAULT (Production + Local Dev)
# Local dev uses --local flag, so these IDs are for production
# ============================================================
[[durable_objects.bindings]]
name = "SYNC_BACKEND_DO"
class_name = "SyncBackendDO"

[[durable_objects.bindings]]
name = "LINK_PROCESSOR_DO"
class_name = "LinkProcessorDO"

[[durable_objects.bindings]]
name = "Chat"
class_name = "ChatAgentDO"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["SyncBackendDO"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["LinkProcessorDO"]

[[migrations]]
tag = "v3"
new_sqlite_classes = ["ChatAgentDO"]

[[d1_databases]]
binding = "DB"
database_name = "cloudstash"
database_id = "9b96a105-9bb7-4ba5-bbe8-1ded0b148f29"
migrations_dir = "drizzle/migrations"

[[kv_namespaces]]
binding = "TELEGRAM_KV"
id = "2ba7eb003f494031ae9fee505ee6111a"

[[ratelimits]]
name = "SYNC_RATE_LIMITER"
namespace_id = "1001"
simple = { limit = 30, period = 60 }

[[analytics_engine_datasets]]
binding = "USAGE_ANALYTICS"
dataset = "cloudstash_usage"

[observability]
enabled = true

[observability.logs]
enabled = true
invocation_logs = true

# ============================================================
# STAGING ENVIRONMENT
# ============================================================
[env.staging]
name = "cloudstash-staging"

[env.staging.ai]
binding = "AI"

[[env.staging.durable_objects.bindings]]
name = "SYNC_BACKEND_DO"
class_name = "SyncBackendDO"

[[env.staging.durable_objects.bindings]]
name = "LINK_PROCESSOR_DO"
class_name = "LinkProcessorDO"

[[env.staging.durable_objects.bindings]]
name = "Chat"
class_name = "ChatAgentDO"

[[env.staging.migrations]]
tag = "v1"
new_sqlite_classes = ["SyncBackendDO"]

[[env.staging.migrations]]
tag = "v2"
new_sqlite_classes = ["LinkProcessorDO"]

[[env.staging.migrations]]
tag = "v3"
new_sqlite_classes = ["ChatAgentDO"]

[[env.staging.d1_databases]]
binding = "DB"
database_name = "cloudstash-staging"
database_id = "ebc9fccf-955c-4b4e-b9a6-36fa8ebdf1aa"
migrations_dir = "drizzle/migrations"

[[env.staging.kv_namespaces]]
binding = "TELEGRAM_KV"
id = "dd0c0cfe847745078e0c7582873a5b86"

[[env.staging.ratelimits]]
name = "SYNC_RATE_LIMITER"
namespace_id = "1001"
simple = { limit = 30, period = 60 }

[[env.staging.analytics_engine_datasets]]
binding = "USAGE_ANALYTICS"
dataset = "cloudstash_usage_staging"
